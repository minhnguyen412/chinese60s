<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dialogue Push Tool â€” Chinese60s</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --black: #222;
    --green: #7cb83e;
    --green-dark: #5a8f27;
    --green-light: #d8f0a0;
    --green-pale: #f2fde0;
    --yellow: #ffd84d;
    --yellow-pale: #fffbe6;
    --peach: #ffb89a;
    --peach-pale: #fff3ee;
    --sky: #72c8f0;
    --sky-pale: #eaf8ff;
    --lavender: #c5b0f8;
    --lavender-pale: #f3f0ff;
    --pink: #ffadc5;
    --pink-pale: #fff2f6;
    --white: #fff;
    --bg: #fffef5;
    --shadow-sm: 3px 3px 0 var(--black);
    --shadow-md: 4px 4px 0 var(--black);
    --shadow-lg: 6px 6px 0 var(--black);
    --border: 2.5px solid var(--black);
    --border-thick: 3px solid var(--black);
  }

  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'Fredoka', sans-serif; font-weight: 500;
    background: var(--bg); color: var(--black);
    min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
  }

  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: radial-gradient(circle, rgba(0,0,0,.045) 1px, transparent 1px);
    background-size: 22px 22px; pointer-events: none; z-index: 0;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    background: var(--green); border-bottom: var(--border-thick);
    padding: 0 50px; height: 66px;
    display: flex; justify-content: space-between; align-items: center;
    position: sticky; top: 0; z-index: 100;
  }
  header h1 { font-weight: 700; font-size: 1.7rem; color: #fff; letter-spacing: .04em; text-shadow: 2px 2px 0 rgba(0,0,0,.25); }
  .subtitle-tag {
    background: var(--yellow); border: var(--border); border-radius: 50px;
    padding: 4px 14px; font-size: .82rem; font-weight: 700; box-shadow: var(--shadow-sm);
  }
  @media(max-width:768px){ header{ padding:0 16px; } .subtitle-tag{ display:none; } }

  /* â”€â”€ CONTAINER â”€â”€ */
  .container {
    max-width: 960px; margin: 0 auto; width: 100%;
    padding: 36px 24px 80px; position: relative; z-index: 1;
    display: flex; flex-direction: column; gap: 20px;
  }

  /* â”€â”€ ANIMATIONS â”€â”€ */
  @keyframes slideUp { from{ opacity:0; transform:translateY(20px) } to{ opacity:1; transform:translateY(0) } }
  @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }

  /* â”€â”€ SECTION CARDS â”€â”€ */
  .card {
    background: var(--white); border: var(--border-thick); border-radius: 24px;
    box-shadow: var(--shadow-md); padding: 24px 28px;
    animation: slideUp .3s ease both;
  }
  .card:nth-child(2){ animation-delay:.06s; }
  .card:nth-child(3){ animation-delay:.12s; }
  .card:nth-child(4){ animation-delay:.18s; }

  .section-label {
    display: inline-block; font-weight: 700; font-size: 1rem;
    background: var(--yellow); border: var(--border); border-radius: 50px;
    padding: 5px 18px; box-shadow: var(--shadow-sm); margin-bottom: 18px;
  }

  /* â”€â”€ FORM FIELDS â”€â”€ */
  .field-row { display: flex; gap: 10px; flex-wrap: wrap; }
  .field { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 160px; }
  label { font-size: .82rem; font-weight: 600; color: #666; }

  input[type=text], input[type=password], input[type=url], textarea, select {
    background: var(--bg); border: var(--border); border-radius: 12px;
    color: var(--black); font-family: 'Fredoka', sans-serif;
    font-size: .95rem; font-weight: 500;
    padding: 9px 14px; outline: none; width: 100%;
    box-shadow: var(--shadow-sm); transition: box-shadow .12s, transform .12s;
  }
  input:focus, textarea:focus, select:focus {
    box-shadow: 5px 5px 0 var(--black); transform: translate(-1px,-1px);
  }
  textarea { resize: vertical; min-height: 64px; }
  select option { background: var(--white); }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn {
    border: var(--border); border-radius: 50px; cursor: pointer;
    font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: .92rem;
    padding: 8px 22px; display: inline-flex; align-items: center; gap: 6px;
    box-shadow: var(--shadow-sm); transition: transform .12s, box-shadow .12s;
    background: var(--white); color: var(--black);
  }
  .btn:hover { transform: translate(-2px,-2px); box-shadow: 5px 5px 0 var(--black); }
  .btn:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 var(--black); }

  .btn-green   { background: var(--green); color: #fff; }
  .btn-yellow  { background: var(--yellow); }
  .btn-sky     { background: var(--sky-pale); }
  .btn-danger  { background: var(--pink-pale); color: #c0392b; }
  .btn-sm      { padding: 5px 14px; font-size: .82rem; }

  /* â”€â”€ GITHUB CONFIG â”€â”€ */
  .config-card {
    background: linear-gradient(135deg, var(--green-pale) 0%, var(--yellow-pale) 100%);
    border: var(--border-thick); border-radius: 24px;
    box-shadow: var(--shadow-lg); padding: 24px 28px;
    animation: slideUp .3s ease both;
  }

  /* â”€â”€ STATUS â”€â”€ */
  .status {
    padding: 10px 16px; border-radius: 14px; font-size: .88rem; font-weight: 700;
    margin-top: 12px; display: none; border: var(--border);
  }
  .status.ok   { background: var(--green-pale);   color: var(--green-dark); display: block; }
  .status.err  { background: var(--pink-pale);    color: #c0392b;           display: block; }
  .status.info { background: var(--sky-pale);     color: #0077aa;           display: block; }

  /* â”€â”€ USERS â”€â”€ */
  .user-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .user-chip {
    display: flex; align-items: center; gap: 8px;
    background: var(--white); border: var(--border); border-radius: 50px;
    padding: 5px 12px 5px 6px; box-shadow: var(--shadow-sm);
  }
  .user-chip img { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--black); object-fit: cover; }
  .user-chip-letter {
    width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--black);
    background: var(--yellow); display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: .9rem;
  }
  .user-chip span { font-weight: 700; font-size: .88rem; }
  .chip-remove { background: none; border: none; cursor: pointer; color: #c0392b; font-size: 1.1rem; line-height: 1; font-weight: 700; }
  .chip-remove:hover { color: var(--black); }

  /* â”€â”€ DIALOGUE ROWS â”€â”€ */
  .dialogue-row {
    background: var(--bg); border: var(--border-thick); border-radius: 18px;
    padding: 16px; margin-bottom: 12px; position: relative;
    box-shadow: var(--shadow-sm); transition: box-shadow .12s;
  }
  .dialogue-row:hover { box-shadow: var(--shadow-md); }

  .row-num {
    position: absolute; top: -14px; left: 16px;
    background: var(--yellow); border: var(--border); border-radius: 50px;
    padding: 1px 12px; font-size: .75rem; font-weight: 700; box-shadow: var(--shadow-sm);
  }

  .row-top { display: flex; gap: 12px; align-items: flex-start; margin-top: 6px; }
  .row-user-col { min-width: 130px; display: flex; flex-direction: column; gap: 5px; align-items: center; }
  .row-avatar { width: 52px; height: 52px; border-radius: 50%; border: var(--border-thick); object-fit: cover; background: var(--green-light); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 700; }
  .row-fields { flex: 1; display: flex; flex-direction: column; gap: 8px; }

  .row-delete {
    position: absolute; top: 10px; right: 12px;
    background: none; border: none; cursor: pointer;
    font-size: 1.1rem; color: #ccc; transition: color .15s;
  }
  .row-delete:hover { color: #c0392b; }

  /* â”€â”€ SEGMENTS â”€â”€ */
  .seg-section { margin-top: 12px; padding-top: 12px; border-top: 2px dashed #ddd; }
  .seg-heading { font-size: .78rem; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: .08em; margin-bottom: 8px; }

  .seg-tokens {
    display: flex; flex-wrap: wrap; gap: 6px;
    background: var(--white); border: var(--border); border-radius: 14px;
    padding: 10px; min-height: 48px; box-shadow: inset 2px 2px 0 rgba(0,0,0,.04);
  }

  .seg-token {
    display: flex; align-items: stretch;
    background: var(--green-pale); border: 2px solid var(--black); border-radius: 10px;
    overflow: hidden; box-shadow: 2px 2px 0 var(--black);
    transition: box-shadow .1s, transform .1s;
  }
  .seg-token:hover { transform: translate(-1px,-1px); box-shadow: 3px 3px 0 var(--black); }

  .seg-text { padding: 5px 9px; font-size: 1.05rem; font-weight: 700; }
  .seg-punct { background: var(--lavender-pale); }
  .seg-punct .seg-text { color: #6366f1; }

  .seg-btn {
    background: none; border: none; border-left: 2px solid var(--black);
    cursor: pointer; padding: 5px 7px; font-size: .72rem; font-weight: 700;
    transition: background .1s;
  }
  .seg-split-btn:hover { background: var(--yellow); }
  .seg-merge-btn:hover { background: var(--peach); }

  .seg-hint { font-size: .72rem; color: #aaa; font-weight: 600; margin-top: 5px; }

  .seg-preview {
    margin-top: 6px; padding: 6px 10px; background: var(--white);
    border: var(--border); border-radius: 10px;
    font-size: .75rem; color: #666; font-weight: 600; word-break: break-all;
    box-shadow: var(--shadow-sm);
  }
  .seg-preview em { color: var(--green-dark); }

  /* â”€â”€ JSON BOX â”€â”€ */
  .json-box {
    background: #1a1a1a; color: #7ef77e; border: var(--border-thick); border-radius: 16px;
    padding: 16px; font-family: monospace; font-size: .78rem;
    white-space: pre-wrap; word-break: break-all;
    max-height: 280px; overflow-y: auto;
    box-shadow: var(--shadow-lg);
  }

  /* â”€â”€ ACTIONS ROW â”€â”€ */
  .actions-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

  /* â”€â”€ EMPTY HINT â”€â”€ */
  .empty-hint {
    text-align: center; padding: 24px; color: #bbb; font-weight: 700; font-size: .92rem;
  }
  .empty-hint .icon { font-size: 2rem; display: block; margin-bottom: 6px; animation: bounce 1.2s ease-in-out infinite; }

  /* â”€â”€ SPINNER â”€â”€ */
  @keyframes spin { to{ transform: rotate(360deg); } }
  .spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2.5px solid rgba(0,0,0,.2); border-top-color: var(--black);
    border-radius: 50%; animation: spin .6s linear infinite;
  }

  /* â”€â”€ FOOTER â”€â”€ */
  footer {
    background: #222; color: rgba(255,255,255,.6); padding: 24px 50px;
    text-align: center; position: relative; z-index: 1; margin-top: auto;
  }
  footer .brand { font-weight: 700; color: var(--green-light); font-size: 1.2rem; margin-bottom: 4px; }

  /* â”€â”€ DIVIDER â”€â”€ */
  hr { border: none; border-top: 2px dashed #e5e5d0; margin: 16px 0; }
</style>
</head>
<body>

<header>
  <h1>CHINESE 60s</h1>
  <span class="subtitle-tag">âœï¸ Dialogue Push Tool</span>
</header>

<div class="container">

  <!-- GITHUB CONFIG -->
  <div class="config-card">
    <div class="section-label">âš™ï¸ GitHub Config</div>
    <div class="field-row">
      <div class="field">
        <label>GitHub Token (repo scope)</label>
        <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
      </div>
      <div class="field">
        <label>Owner / Repo</label>
        <input type="text" id="ghRepo" placeholder="username/repo-name">
      </div>
      <div class="field" style="max-width:200px">
        <label>File path</label>
        <input type="text" id="ghPath" value="data/posts.json">
      </div>
      <div class="field" style="max-width:140px">
        <label>Branch</label>
        <input type="text" id="ghBranch" value="main">
      </div>
    </div>
    <div style="margin-top:12px">
      <button class="btn btn-sm btn-sky" onclick="fetchCurrentJson()">ğŸ”„ Load posts.json from GitHub</button>
    </div>
    <div id="loadStatus" class="status"></div>
  </div>

  <!-- USERS -->
  <div class="card">
    <div class="section-label">ğŸ‘¤ Characters / Users</div>
    <div class="field-row" style="align-items:flex-end">
      <div class="field">
        <label>Name</label>
        <input type="text" id="newUserName" placeholder="A, Teacher Wang, â€¦">
      </div>
      <div class="field">
        <label>Avatar URL <span style="color:#bbb;font-weight:500">(optional)</span></label>
        <input type="url" id="newUserAvatar" placeholder="https://â€¦">
      </div>
      <button class="btn btn-green btn-sm" onclick="addUser()" style="margin-bottom:2px">+ Add User</button>
    </div>
    <div class="user-chips" id="userList">
      <div class="empty-hint" style="padding:10px;color:#bbb;font-size:.85rem">No users yet â€” add characters above</div>
    </div>
  </div>

  <!-- DIALOGUE ROWS -->
  <div class="card">
    <div class="section-label">ğŸ’¬ Dialogue Lines</div>
    <div id="dialogueRows">
      <div class="empty-hint">
        <span class="icon">ğŸ—£ï¸</span>
        Add users first, then build your dialogue below
      </div>
    </div>
    <div style="margin-top:4px">
      <button class="btn btn-yellow" onclick="addRow()">+ Add Line</button>
    </div>
  </div>

  <!-- PREVIEW & PUSH -->
  <div class="card">
    <div class="section-label">ğŸš€ Preview &amp; Push</div>
    <div class="actions-row">
      <button class="btn btn-sky" onclick="buildPreview()">ğŸ” Preview JSON</button>
      <button class="btn btn-green" onclick="pushToGitHub()" id="pushBtn">ğŸš€ Push to GitHub</button>
    </div>
    <pre class="json-box" id="jsonPreview" style="margin-top:14px">// Click "Preview JSON" to see what will be appendedâ€¦</pre>
    <div id="pushStatus" class="status"></div>
  </div>

</div>

<footer>
  <p class="brand">CHINESE 60s</p>
  <p>Build dialogues Â· Push to GitHub Â· Keep learning</p>
</footer>

<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let users = [];
let rows  = [];
let existingPosts = [];
let currentSha    = '';

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const getConfig = () => ({
  token:  document.getElementById('ghToken').value.trim(),
  repo:   document.getElementById('ghRepo').value.trim(),
  path:   document.getElementById('ghPath').value.trim(),
  branch: document.getElementById('ghBranch').value.trim() || 'main',
});
function showStatus(id, type, html) {
  const el = document.getElementById(id);
  el.className = 'status ' + type;
  el.innerHTML = html;
}

// â”€â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addUser() {
  const name   = document.getElementById('newUserName').value.trim();
  const avatar = document.getElementById('newUserAvatar').value.trim();
  if (!name) return alert('Please enter a user name.');
  if (users.find(u => u.name === name)) return alert('User already exists.');
  users.push({ name, avatar });
  document.getElementById('newUserName').value   = '';
  document.getElementById('newUserAvatar').value = '';
  renderUsers(); renderRows();
}

function removeUser(name) {
  if (!confirm(`Remove user "${name}"?`)) return;
  users = users.filter(u => u.name !== name);
  rows.forEach(r => { if (r.user === name) r.user = users[0]?.name || ''; });
  renderUsers(); renderRows();
}

function renderUsers() {
  const el = document.getElementById('userList');
  if (!users.length) {
    el.innerHTML = '<div style="padding:10px;color:#bbb;font-size:.85rem;font-weight:600">No users yet â€” add characters above</div>';
    return;
  }
  el.innerHTML = users.map(u => `
    <div class="user-chip">
      ${u.avatar
        ? `<img src="${esc(u.avatar)}" alt="${esc(u.name)}" onerror="this.outerHTML='<div class=user-chip-letter>${esc(u.name[0].toUpperCase())}</div>'">`
        : `<div class="user-chip-letter">${esc(u.name[0].toUpperCase())}</div>`}
      <span>${esc(u.name)}</span>
      <button class="chip-remove" onclick="removeUser('${esc(u.name)}')" title="Remove">Ã—</button>
    </div>
  `).join('');
}

// â”€â”€â”€ DIALOGUE ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addRow() {
  if (!users.length) { alert('Add at least one user first.'); return; }
  rows.push({ id: Date.now(), user: users[0].name, title:'', description:'', audioSrc:'', segments:[] });
  renderRows();
}

function removeRow(id) {
  rows = rows.filter(r => r.id !== id);
  renderRows();
}

function updateRow(id, field, value) {
  const row = rows.find(r => r.id === id);
  if (row) row[field] = value;
}

function updateRowTitle(id, value) {
  const row = rows.find(r => r.id === id);
  if (!row) return;
  row.title = value;
  row.segments = autoTokenize(value);
  renderRows();
}

function renderRows() {
  const el = document.getElementById('dialogueRows');
  if (!rows.length) {
    el.innerHTML = users.length
      ? '<div class="empty-hint"><span class="icon">ğŸ’¬</span>Click "Add Line" to start building the dialogue</div>'
      : '<div class="empty-hint"><span class="icon">ğŸ—£ï¸</span>Add users first, then build your dialogue below</div>';
    return;
  }
  el.innerHTML = rows.map((row, idx) => {
    const user = users.find(u => u.name === row.user);
    return `
      <div class="dialogue-row">
        <span class="row-num">Line ${idx + 1}</span>
        <button class="row-delete" onclick="removeRow(${row.id})" title="Remove line">âœ•</button>
        <div class="row-top">
          <div class="row-user-col">
            ${user?.avatar
              ? `<div class="row-avatar" style="background:none;padding:0"><img src="${esc(user.avatar)}" style="width:52px;height:52px;border-radius:50%;border:2.5px solid #222;object-fit:cover" onerror="this.outerHTML='<div class=row-avatar>${esc((user?.name||'?')[0].toUpperCase())}</div>'"></div>`
              : `<div class="row-avatar">${esc((user?.name||'?')[0].toUpperCase())}</div>`}
            <select style="font-size:.8rem;padding:5px 8px;border-radius:10px;text-align:center" onchange="updateRow(${row.id},'user',this.value);renderRows()">
              ${users.map(u => `<option value="${esc(u.name)}" ${row.user===u.name?'selected':''}>${esc(u.name)}</option>`).join('')}
            </select>
          </div>
          <div class="row-fields">
            <div class="field">
              <label>Chinese Title</label>
              <input type="text" placeholder="è¿™æ˜¯ç‹è€å¸ˆâ€¦" value="${esc(row.title)}"
                oninput="updateRowTitle(${row.id}, this.value)">
            </div>
            <div class="field">
              <label>Description <span style="color:#bbb;font-weight:500">(pinyin&lt;br&gt;English)</span></label>
              <textarea placeholder="wÃ¡ng lÇoshÄ« nÃ­n hÇo&lt;br&gt;Teacher Wang, hello!" oninput="updateRow(${row.id},'description',this.value)">${esc(row.description)}</textarea>
            </div>
            <div class="field">
              <label>Audio URL</label>
              <input type="url" placeholder="https://res.cloudinary.com/â€¦" value="${esc(row.audioSrc)}"
                oninput="updateRow(${row.id},'audioSrc',this.value)">
            </div>
          </div>
        </div>
        ${row.title ? renderSegments(row) : ''}
      </div>
    `;
  }).join('');
}

// â”€â”€â”€ TOKENIZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isPunct(ch) {
  return /[ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š""''ï¼ˆï¼‰ã€Šã€‹ã€ã€‘ã€Œã€ã€ã€â€¦â€”Â·ï½\s,.!?;:'"()\[\]{}<>Â·]/.test(ch);
}

function autoTokenize(text) {
  if (!text) return [];
  const tokens = []; let cur = '';
  for (const ch of text) {
    if (isPunct(ch)) { if (cur) { tokens.push(cur); cur=''; } if (ch.trim()) tokens.push(ch); }
    else cur += ch;
  }
  if (cur) tokens.push(cur);
  return tokens;
}

function renderSegments(row) {
  if (!row.segments.length) return '';
  return `
    <div class="seg-section">
      <div class="seg-heading">âœ‚ï¸ Split &amp; Merge Segments</div>
      <div class="seg-tokens">
        ${row.segments.map((seg, i) => {
          const punct = isPunct(seg[0]);
          return `
            <div class="seg-token ${punct ? 'seg-punct' : ''}">
              <span class="seg-text">${esc(seg)}</span>
              ${seg.length > 1 && !punct
                ? `<button class="seg-btn seg-split-btn" onclick="splitSeg(${row.id},${i})" title="Split off first character">âœ‚</button>`
                : ''}
              ${i > 0
                ? `<button class="seg-btn seg-merge-btn" onclick="mergeSeg(${row.id},${i})" title="Merge with previous token">â†</button>`
                : ''}
            </div>`;
        }).join('')}
      </div>
      <div class="seg-hint">âœ‚ = split first character off this token &nbsp;Â·&nbsp; â† = merge with previous token</div>
      <div class="seg-preview"><em>Segments:</em> [${row.segments.map(s => `"${s}"`).join(', ')}]</div>
    </div>
  `;
}

function splitSeg(rowId, idx) {
  const row = rows.find(r => r.id === rowId);
  if (!row) return;
  const tok = row.segments[idx];
  if (tok.length < 2) return;
  row.segments.splice(idx, 1, tok[0], tok.slice(1));
  renderRows();
}

function mergeSeg(rowId, idx) {
  const row = rows.find(r => r.id === rowId);
  if (!row || idx === 0) return;
  const merged = row.segments[idx - 1] + row.segments[idx];
  row.segments.splice(idx - 1, 2, merged);
  renderRows();
}

// â”€â”€â”€ GITHUB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchCurrentJson() {
  const { token, repo, path, branch } = getConfig();
  if (!token || !repo) return showStatus('loadStatus','err','âš ï¸ Please enter your GitHub token and repo first.');
  showStatus('loadStatus','info','<span class="spinner"></span> Loading posts.jsonâ€¦');
  try {
    const res  = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
      headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status} â€” ${res.statusText}`);
    const data = await res.json();
    currentSha    = data.sha;
    existingPosts = JSON.parse(atob(data.content.replace(/\n/g,'')));
    showStatus('loadStatus','ok',`âœ… Loaded ${existingPosts.length} post(s). Next ID will be: <strong>${nextId()}</strong>`);
  } catch(e) {
    showStatus('loadStatus','err','âŒ Error: ' + e.message);
  }
}

function nextId() {
  return existingPosts.length ? Math.max(...existingPosts.map(p => p.id)) + 1 : 1;
}

function buildNewPosts() {
  let id = nextId();
  return rows.map(row => {
    const user = users.find(u => u.name === row.user);
    return {
      id: id++,
      user: row.user,
      title: row.title,
      segments: row.segments,
      description: row.description,
      avatar: user?.avatar || '',
      audioSrc: row.audioSrc,
    };
  });
}

function buildPreview() {
  if (!rows.length) {
    document.getElementById('jsonPreview').textContent = '// No dialogue lines yet â€” add some lines first.';
    return;
  }
  document.getElementById('jsonPreview').textContent = JSON.stringify(buildNewPosts(), null, 2);
}

async function pushToGitHub() {
  const { token, repo, path, branch } = getConfig();
  if (!token || !repo) return showStatus('pushStatus','err','âš ï¸ Enter your GitHub token and repo.');
  if (!rows.length)    return showStatus('pushStatus','err','âš ï¸ Add at least one dialogue line.');

  const btn = document.getElementById('pushBtn');
  btn.disabled = true;
  showStatus('pushStatus','info','<span class="spinner"></span> Pushing to GitHubâ€¦');

  const newPosts = buildNewPosts();
  const allPosts = [...existingPosts, ...newPosts];
  const content  = btoa(unescape(encodeURIComponent(JSON.stringify(allPosts, null, 4))));

  const body = {
    message: `Add ${newPosts.length} dialogue post(s) (id ${newPosts[0].id}â€“${newPosts[newPosts.length-1].id})`,
    content, branch,
  };
  if (currentSha) body.sha = currentSha;

  try {
    const res  = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

    currentSha    = data.content.sha;
    existingPosts = allPosts;

    showStatus('pushStatus','ok',
      `ğŸ‰ Successfully pushed! Added <strong>${newPosts.length} post(s)</strong>. Commit: <code>${data.commit.sha.slice(0,7)}</code>`);

    rows = [];
    renderRows();
    document.getElementById('jsonPreview').textContent = '// Done! Lines have been pushed. Load again to verify.';
  } catch(e) {
    showStatus('pushStatus','err','âŒ Push failed: ' + e.message);
  } finally {
    btn.disabled = false;
  }
}
</script>
</body>
</html>
