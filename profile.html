<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile ‚Äî Chinese60s</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --black: #222;
      --green: #7cb83e;
      --green-dark: #5a8f27;
      --green-light: #d8f0a0;
      --green-pale: #f2fde0;
      --yellow: #ffd84d;
      --yellow-pale: #fffbe6;
      --peach: #ffb89a;
      --peach-pale: #fff3ee;
      --sky: #72c8f0;
      --sky-pale: #eaf8ff;
      --lavender: #c5b0f8;
      --lavender-pale: #f3f0ff;
      --pink: #ffadc5;
      --pink-pale: #fff2f6;
      --white: #fff;
      --bg: #fffef5;
      --shadow-sm: 3px 3px 0 var(--black);
      --shadow-md: 4px 4px 0 var(--black);
      --shadow-lg: 6px 6px 0 var(--black);
      --border: 2.5px solid var(--black);
      --border-thick: 3px solid var(--black);
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }

    body {
      font-family: 'Fredoka', sans-serif;
      font-weight: 500;
      background: var(--bg);
      color: var(--black);
      overflow-x: hidden;
      min-height: 100vh;
      display: flex; flex-direction: column;
    }
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: radial-gradient(circle, rgba(0,0,0,0.045) 1px, transparent 1px);
      background-size: 22px 22px;
      pointer-events: none; z-index: 0;
    }

    header {
      background: var(--green);
      border-bottom: var(--border-thick);
      padding: 0 50px; height: 66px;
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 100;
    }
    header h1 { font-weight: 700; font-size: 1.7rem; color: white; letter-spacing: 0.04em; text-shadow: 2px 2px 0 rgba(0,0,0,0.25); }
    .homepage-link { text-decoration: none; color: inherit; }
    nav ul { list-style: none; display: flex; gap: 8px; align-items: center; }
    nav ul li a {
      text-decoration: none; color: var(--black); font-weight: 600; font-size: 0.95rem;
      background: var(--white); border: var(--border); border-radius: 50px;
      padding: 6px 16px; display: inline-block;
      box-shadow: var(--shadow-sm); transition: transform 0.12s, box-shadow 0.12s;
    }
    nav ul li a:hover { transform: translate(-2px,-2px); box-shadow: 5px 5px 0 var(--black); }
    @media (max-width: 768px) { header { padding: 0 16px; } }

    .container {
      max-width: 1000px; margin: 0 auto; width: 100%;
      padding: 36px 24px 80px;
      position: relative; z-index: 1;
      display: flex; flex-direction: column; gap: 24px;
    }

    /* LOADING */
    .loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; padding: 80px 0; }
    .loading-dots { display: flex; gap: 8px; }
    .loading-dots span { width: 12px; height: 12px; border-radius: 50%; background: var(--green); animation: bounce 0.8s ease-in-out infinite; }
    .loading-dots span:nth-child(2) { animation-delay: .15s; background: var(--yellow); }
    .loading-dots span:nth-child(3) { animation-delay: .3s; background: var(--pink); }
    @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .loading-screen p { font-size: 1rem; color: #888; font-weight: 600; }

    /* PROFILE HERO */
    .profile-hero {
      background: var(--white); border: var(--border-thick); border-radius: 24px;
      box-shadow: var(--shadow-md); padding: 28px 32px;
      display: flex; align-items: center; gap: 24px;
      animation: slideUp .35s ease both;
    }
    @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
    .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: var(--border-thick); object-fit: cover; display: block; background: var(--green-light); }
    .profile-avatar-fallback { width: 80px; height: 80px; border-radius: 50%; border: var(--border-thick); background: var(--green-light); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; }
    .profile-info { flex: 1; min-width: 0; }
    .profile-info h2 { font-size: 1.8rem; font-weight: 700; line-height: 1.2; }
    .profile-info p { font-size: 0.95rem; color: #666; margin-top: 4px; }
    .profile-badge { display: inline-flex; align-items: center; gap: 6px; background: var(--green-pale); border: var(--border); border-radius: 50px; padding: 4px 14px; font-size: 0.85rem; font-weight: 700; margin-top: 10px; box-shadow: var(--shadow-sm); }
    .streak-badge { display: inline-flex; align-items: center; gap: 6px; background: var(--peach-pale); border: var(--border); border-radius: 50px; padding: 4px 14px; font-size: 0.85rem; font-weight: 700; margin-top: 8px; box-shadow: var(--shadow-sm); }
    .signout-btn { background: var(--pink-pale); border: var(--border); border-radius: 50px; padding: 8px 22px; font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 0.95rem; cursor: pointer; box-shadow: var(--shadow-sm); color: #c0392b; transition: transform .12s, box-shadow .12s; }
    .signout-btn:hover { transform: translate(-2px,-2px); box-shadow: 5px 5px 0 var(--black); }

    /* ‚ïê‚ïê‚ïê SCORE BREAKDOWN CARD ‚ïê‚ïê‚ïê */
    .score-card {
      background: var(--white); border: var(--border-thick); border-radius: 22px;
      box-shadow: var(--shadow-md); padding: 24px 28px;
      animation: slideUp .35s .05s ease both;
    }
    .score-card-title {
      font-weight: 700; font-size: 1.2rem;
      background: var(--green); color: white;
      border: var(--border); border-radius: 50px;
      padding: 6px 20px; display: inline-block;
      box-shadow: var(--shadow-sm); margin-bottom: 20px;
    }
    .score-breakdown {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px;
    }
    @media(max-width:600px){ .score-breakdown { grid-template-columns: repeat(2,1fr); } }

    .score-block {
      border: var(--border-thick); border-radius: 18px;
      padding: 18px 14px; text-align: center;
      box-shadow: var(--shadow-sm);
      transition: transform .12s, box-shadow .12s;
    }
    .score-block:hover { transform: translate(-2px,-2px); box-shadow: var(--shadow-md); }
    .score-block.total-block { background: var(--yellow-pale); }
    .score-block.quiz-block  { background: var(--green-pale); }
    .score-block.speak-block { background: var(--sky-pale); }
    .score-block.write-block { background: var(--lavender-pale); }

    .score-block .big-num { font-size: 2.4rem; font-weight: 700; line-height: 1; }
    .score-block .score-lbl { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: #666; margin-top: 6px; }
    .score-block .score-sub { font-size: 0.75rem; color: #999; margin-top: 4px; }

    .score-formula {
      display: flex; align-items: center; justify-content: center;
      gap: 8px; margin-top: 16px; flex-wrap: wrap;
      font-size: 0.88rem; color: #888; font-weight: 600;
    }
    .formula-pill {
      padding: 3px 12px; border: var(--border); border-radius: 50px;
      background: var(--white); box-shadow: var(--shadow-sm); font-weight: 700;
    }
    .formula-pill.q { background: var(--green-pale); }
    .formula-pill.s { background: var(--sky-pale); }
    .formula-pill.w { background: var(--lavender-pale); }
    .formula-plus { font-size: 1.1rem; color: #bbb; }

    /* SECTION CARD */
    .section-card { background: var(--white); border: var(--border-thick); border-radius: 22px; box-shadow: var(--shadow-md); padding: 24px 28px; animation: slideUp .35s .2s ease both; }
    .section-title { display: inline-flex; align-items: center; gap: 8px; font-weight: 700; font-size: 1.2rem; background: var(--yellow); border: var(--border); border-radius: 50px; padding: 6px 20px; box-shadow: var(--shadow-sm); margin-bottom: 18px; }

    /* TABS */
    .tabs { display: flex; gap: 8px; margin-bottom: 18px; flex-wrap: wrap; }
    .tab-btn { padding: 7px 18px; border: var(--border); border-radius: 50px; font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 0.9rem; cursor: pointer; background: var(--white); box-shadow: var(--shadow-sm); transition: transform .1s, box-shadow .1s; }
    .tab-btn:hover { transform: translate(-1px,-1px); box-shadow: 4px 4px 0 var(--black); }
    .tab-btn.active { background: var(--green); color: white; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* QUIZ TAB */
    .quiz-attempt-block {
      background: var(--bg); border: var(--border); border-radius: 14px;
      padding: 14px 16px; margin-bottom: 12px;
    }
    .quiz-attempt-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 10px; flex-wrap: wrap; gap: 8px;
    }
    .quiz-attempt-header .meta { font-size: 0.82rem; color: #888; }
    .quiz-score-badge { padding: 3px 12px; border-radius: 50px; font-size: 0.85rem; font-weight: 700; border: 2px solid var(--black); }
    .quiz-score-badge.good { background: var(--green-light); }
    .quiz-score-badge.ok   { background: var(--yellow); }
    .quiz-score-badge.low  { background: var(--pink); }

    .wrong-list { display: flex; flex-direction: column; gap: 5px; margin-top: 6px; }
    .wrong-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 10px; border-radius: 10px; background: var(--white); border: var(--border); font-size: 0.85rem; }
    .wrong-x { color: #e53935; font-weight: 700; flex-shrink: 0; }
    .wrong-text .q-label { font-size: 0.78rem; color: #aaa; }
    .wrong-text .correct { color: var(--green-dark); font-weight: 700; }

    /* SPEAK TAB */
    .rec-item { padding: 10px 14px; border-radius: 12px; background: var(--white); border: var(--border); margin-bottom: 8px; font-size: 0.9rem; line-height: 1.55; }
    .rec-item .rec-said { font-weight: 600; font-size: 1rem; }
    .rec-item .rec-meta { font-size: 0.78rem; color: #aaa; margin-top: 3px; }

    /* WRITE TAB */
    .write-attempt-block { background: var(--bg); border: var(--border); border-radius: 14px; padding: 14px 16px; margin-bottom: 12px; }
    .write-attempt-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
    .write-score-badge { padding: 3px 12px; border-radius: 50px; font-size: 0.85rem; font-weight: 700; border: 2px solid var(--black); background: var(--lavender); }
    .write-wrong-chars { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
    .char-pill {
      display: inline-flex; align-items: center; justify-content: center;
      width: 44px; height: 44px;
      background: var(--white); border: var(--border); border-radius: 10px;
      font-size: 1.4rem; font-weight: 700; box-shadow: var(--shadow-sm);
      color: #e53935;
    }
    .char-pill-label { font-size: 0.72rem; color: #aaa; text-align: center; margin-top: 2px; font-family: 'Quicksand', sans-serif; }
    .char-pill-wrap { display: flex; flex-direction: column; align-items: center; }

    /* TABLE */
    .history-table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.92rem; }
    thead tr { background: var(--yellow-pale); }
    th { padding: 10px 14px; text-align: left; font-weight: 700; border-bottom: var(--border); white-space: nowrap; }
    td { padding: 10px 14px; border-bottom: 1.5px solid #f0f0f0; vertical-align: middle; }
    tbody tr:hover { background: var(--bg); }
    tbody tr:last-child td { border-bottom: none; }

    /* EMPTY */
    .empty-state { text-align: center; padding: 24px 0; color: #bbb; font-size: 0.95rem; font-weight: 600; }
    .empty-state span { font-size: 1.8rem; display: block; margin-bottom: 6px; }

    footer { background: #222; color: rgba(255,255,255,0.65); padding: 28px 50px; text-align: center; position: relative; z-index: 1; margin-top: auto; }
    footer .brand { font-weight: 700; color: var(--green-light); font-size: 1.3rem; margin-bottom: 6px; }
    footer p { font-size: 0.95rem; }
  </style>
</head>
<body>

  <header>
    <h1><a href="index.html" class="homepage-link">CHINESE 60s</a></h1>
    <nav>
      <ul><li><a href="index.html">‚Üê Back</a></li></ul>
    </nav>
  </header>

  <div class="container" id="app">
    <div class="loading-screen" id="loading">
      <div class="loading-dots"><span></span><span></span><span></span></div>
      <p>Loading your profile...</p>
    </div>
  </div>

  <footer>
    <p class="brand">CHINESE 60s</p>
    <p>Learn Mandarin through images and videos</p>
  </footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection,
  query, where, getDocs, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyAm-qQrpXKNdqFLITRAGCug7rkskGzyAkg",
  authDomain:        "chinese60s.firebaseapp.com",
  projectId:         "chinese60s",
  storageBucket:     "chinese60s.firebasestorage.app",
  messagingSenderId: "835657861121",
  appId:             "1:835657861121:web:f31727eb7ea3b876a5d800",
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function fmtDate(ts) {
  if (!ts) return '‚Äî';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
}
function scoreColor(score, total) {
  const pct = total ? score / total : 0;
  if (pct >= 0.8) return 'good';
  if (pct >= 0.5) return 'ok';
  return 'low';
}
function calcStreak(quizAttempts, recordings) {
  const allDates = new Set();
  const toStr = ts => {
    if (!ts) return null;
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toISOString().split('T')[0];
  };
  quizAttempts.forEach(a => { const s = toStr(a.startTime); if (s) allDates.add(s); });
  recordings.forEach(r => { const s = toStr(r.timestamp); if (s) allDates.add(s); });
  if (!allDates.size) return 0;
  let streak = 0, check = new Date();
  const todayStr = check.toISOString().split('T')[0];
  while (true) {
    const str = check.toISOString().split('T')[0];
    if (allDates.has(str)) { streak++; check.setDate(check.getDate()-1); }
    else if (str === todayStr) { check.setDate(check.getDate()-1); if (!allDates.has(check.toISOString().split('T')[0])) break; }
    else break;
  }
  return streak;
}

/* ‚îÄ‚îÄ Build UI ‚îÄ‚îÄ */
function buildProfile(user, quizAttempts, recordings, writingAttempts) {

  /* ‚îÄ‚îÄ SCORE CALCULATION ‚îÄ‚îÄ */
  // Quiz score: sum of all quiz attempt scores
  const quizScore   = quizAttempts.reduce((s, a) => s + (a.score || 0), 0);
  // Speak score: 1 point per recording (regardless of correctness)
  const speakScore  = recordings.length;
  // Write score: sum of all writing attempt scores
  const writeScore  = Math.round(writingAttempts.reduce((s, a) => s + (a.score || 0), 0) * 10) / 10;
  // Total
  const totalScore  = Math.round((quizScore + speakScore + writeScore) * 10) / 10;

  const streak = calcStreak(quizAttempts, recordings);

  /* ‚îÄ‚îÄ ALL WRONG QUIZ ANSWERS (flattened with attempt info) ‚îÄ‚îÄ */
  // Used in quiz tab ‚Äî each attempt lists its wrong answers
  // Nothing extra needed here, handled per-attempt in render

  /* ‚îÄ‚îÄ ALL WRONG WRITE CHARS ‚îÄ‚îÄ */
  // From writing_attempts.wrongAnswers: [{character, word, wrongAttempts, pointsEarned}]
  // Zero-point chars = wrongAttempts >= 2
  const writeZeroChars = [];
  writingAttempts.forEach(a => {
    (a.wrongAnswers || []).forEach(w => {
      if (w.pointsEarned === 0 || w.wrongAttempts >= 2) {
        writeZeroChars.push(w.character);
      }
    });
  });
  // Unique chars
  const uniqueZeroChars = [...new Set(writeZeroChars)];

  const appEl = document.getElementById('app');
  appEl.innerHTML = `

    <!-- PROFILE HERO -->
    <div class="profile-hero">
      <div>
        ${user.photoURL
          ? `<img class="profile-avatar" src="${user.photoURL}" referrerpolicy="no-referrer" alt="avatar">`
          : `<div class="profile-avatar-fallback">${(user.displayName?.[0]||'?').toUpperCase()}</div>`}
      </div>
      <div class="profile-info">
        <h2>${user.displayName || 'Learner'}</h2>
        <p>${user.email}</p>
        <div class="profile-badge">üéì Chinese Learner</div>
        ${streak > 0 ? `<div class="streak-badge">üî• ${streak}-day streak</div>` : ''}
      </div>
      <button class="signout-btn" id="signout-btn">üö™ Sign Out</button>
    </div>

    <!-- SCORE BREAKDOWN -->
    <div class="score-card">
      <div class="score-card-title">‚≠ê Score Overview</div>
      <div class="score-breakdown">
        <div class="score-block total-block">
          <div class="big-num">üèÜ ${totalScore}</div>
          <div class="score-lbl">Total Score</div>
          <div class="score-sub">Quiz + Speak + Write</div>
        </div>
        <div class="score-block quiz-block">
          <div class="big-num">${quizScore}</div>
          <div class="score-lbl">üìù Quiz</div>
          <div class="score-sub">${quizAttempts.length} attempt${quizAttempts.length !== 1 ? 's' : ''}</div>
        </div>
        <div class="score-block speak-block">
          <div class="big-num">${speakScore}</div>
          <div class="score-lbl">üéô Speak</div>
          <div class="score-sub">${speakScore} sentence${speakScore !== 1 ? 's' : ''} spoken</div>
        </div>
        <div class="score-block write-block">
          <div class="big-num">${writeScore}</div>
          <div class="score-lbl">‚úèÔ∏è Write</div>
          <div class="score-sub">${writingAttempts.length} attempt${writingAttempts.length !== 1 ? 's' : ''}</div>
        </div>
      </div>
      <div class="score-formula">
        <span>Total =</span>
        <span class="formula-pill q">Quiz ${quizScore}</span>
        <span class="formula-plus">+</span>
        <span class="formula-pill s">Speak ${speakScore}</span>
        <span class="formula-plus">+</span>
        <span class="formula-pill w">Write ${writeScore}</span>
        <span class="formula-plus">=</span>
        <span class="formula-pill" style="background:var(--yellow);font-size:1rem">üèÜ ${totalScore}</span>
      </div>
    </div>

    <!-- DETAIL TABS -->
    <div class="section-card">
      <div class="section-title">üìã Activity Details</div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="quiz">üìù Quiz (${quizAttempts.length})</button>
        <button class="tab-btn" data-tab="speak">üéô Speak (${speakScore})</button>
        <button class="tab-btn" data-tab="write">‚úèÔ∏è Write (${writingAttempts.length})</button>
      </div>

      <!-- ‚îÄ‚îÄ QUIZ TAB ‚îÄ‚îÄ -->
      <div class="tab-panel active" id="tab-quiz">
        ${quizAttempts.length === 0
          ? `<div class="empty-state"><span>üìù</span>No quiz attempts yet</div>`
          : quizAttempts.map(a => {
              const wrong = a.wrongAnswers || [];
              const pct = a.totalQuestions ? Math.round(a.score / a.totalQuestions * 100) : 0;
              return `
                <div class="quiz-attempt-block">
                  <div class="quiz-attempt-header">
                    <div>
                      <strong>Lesson #${a.postId || '?'}</strong>
                      <span class="meta" style="margin-left:8px">${fmtDate(a.startTime)}</span>
                    </div>
                    <span class="quiz-score-badge ${scoreColor(a.score, a.totalQuestions)}">
                      ${a.score}/${a.totalQuestions} &nbsp;(${pct}%)
                    </span>
                  </div>
                  ${wrong.length > 0
                    ? `<div class="wrong-list">
                        ${wrong.map(w => `
                          <div class="wrong-item">
                            <span class="wrong-x">‚úó</span>
                            <div class="wrong-text">
                              ${w.question ? `<div class="q-label">${w.question}</div>` : ''}
                              <div>You: <em style="color:#c0392b">${w.given || '?'}</em>
                              ‚Üí <span class="correct">‚úì ${w.answer || '?'}</span></div>
                            </div>
                          </div>`).join('')}
                       </div>`
                    : `<div style="font-size:.85rem;color:var(--green-dark);font-weight:700">‚úÖ Perfect ‚Äî no mistakes!</div>`
                  }
                </div>`;
            }).join('')
        }
      </div>

      <!-- ‚îÄ‚îÄ SPEAK TAB ‚îÄ‚îÄ -->
      <div class="tab-panel" id="tab-speak">
        ${recordings.length === 0
          ? `<div class="empty-state"><span>üéô</span>No recordings yet</div>`
          : `<p style="font-size:.85rem;color:#888;margin-bottom:14px;font-weight:600">
               Each sentence spoken = 1 point. Total: <strong style="color:var(--black)">${speakScore} pts</strong>
             </p>
             ${recordings.map(r => `
               <div class="rec-item">
                 <div class="rec-said">üó£ ${r.transcript || '(no transcript)'}</div>
                 <div class="rec-meta">
                   Original: <strong>${r.correctSentence || '‚Äî'}</strong>
                   &nbsp;¬∑&nbsp; Lesson #${r.postId || '?'}
                   &nbsp;¬∑&nbsp; ${fmtDate(r.timestamp)}
                 </div>
               </div>`).join('')}`
        }
      </div>

      <!-- ‚îÄ‚îÄ WRITE TAB ‚îÄ‚îÄ -->
      <div class="tab-panel" id="tab-write">
        ${writingAttempts.length === 0
          ? `<div class="empty-state"><span>‚úèÔ∏è</span>No writing practice yet</div>`
          : `
            ${uniqueZeroChars.length > 0 ? `
              <div style="background:var(--pink-pale);border:var(--border);border-radius:14px;padding:14px 16px;margin-bottom:16px;">
                <div style="font-weight:700;font-size:.9rem;margin-bottom:10px;color:#c0392b">
                  ‚ùå Characters to review (scored 0 pt):
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:10px;">
                  ${uniqueZeroChars.map(c => `
                    <div class="char-pill-wrap">
                      <div class="char-pill">${c}</div>
                    </div>`).join('')}
                </div>
              </div>` : ''}

            ${writingAttempts.map(a => {
              const zeroChars = (a.wrongAnswers || [])
                .filter(w => w.pointsEarned === 0 || w.wrongAttempts >= 2)
                .map(w => w.character);
              const halfChars = (a.wrongAnswers || [])
                .filter(w => w.pointsEarned === 0.5 || w.wrongAttempts === 1)
                .map(w => w.character);
              return `
                <div class="write-attempt-block">
                  <div class="write-attempt-header">
                    <div>
                      <strong>Lesson #${a.postId || '?'}</strong>
                      <span style="font-size:.82rem;color:#888;margin-left:8px">${fmtDate(a.timestamp)}</span>
                    </div>
                    <span class="write-score-badge">${a.score} / ${a.totalCards} pts</span>
                  </div>
                  ${zeroChars.length > 0 ? `
                    <div style="margin-bottom:6px">
                      <span style="font-size:.78rem;font-weight:700;color:#e53935;text-transform:uppercase;letter-spacing:.05em">0 pt (2+ mistakes):</span>
                      <div class="write-wrong-chars" style="margin-top:6px">
                        ${zeroChars.map(c => `<div class="char-pill-wrap"><div class="char-pill">${c}</div></div>`).join('')}
                      </div>
                    </div>` : ''}
                  ${halfChars.length > 0 ? `
                    <div>
                      <span style="font-size:.78rem;font-weight:700;color:#f39c12;text-transform:uppercase;letter-spacing:.05em">0.5 pt (1 mistake):</span>
                      <div class="write-wrong-chars" style="margin-top:6px">
                        ${halfChars.map(c => `
                          <div class="char-pill-wrap">
                            <div class="char-pill" style="color:#f39c12;border-color:#f39c12">${c}</div>
                          </div>`).join('')}
                      </div>
                    </div>` : ''}
                  ${zeroChars.length === 0 && halfChars.length === 0
                    ? `<div style="font-size:.85rem;color:var(--green-dark);font-weight:700">‚úÖ All correct!</div>`
                    : ''}
                </div>`;
            }).join('')}
          `
        }
      </div>

    </div>
  `;

  /* Sign out */
  document.getElementById('signout-btn').addEventListener('click', async () => {
    await signOut(auth);
    window.location.href = 'index.html';
  });

  /* Tab switching */
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
  });
}

/* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = 'index.html'; return; }

  try {
    /* Quiz attempts */
    let quizAttempts = [];
    try {
      const s = await getDocs(query(
        collection(db, 'quiz_attempts'),
        where('uid', '==', user.uid),
        orderBy('startTime', 'desc')
      ));
      quizAttempts = s.docs.map(d => d.data());
    } catch(e) { console.warn('quiz_attempts:', e); }

    /* Recordings (speak) */
    let recordings = [];
    try {
      const s = await getDocs(query(
        collection(db, 'recordings'),
        where('uid', '==', user.uid),
        orderBy('timestamp', 'desc')
      ));
      recordings = s.docs.map(d => d.data());
    } catch(e) { console.warn('recordings:', e); }

    /* Writing attempts */
    let writingAttempts = [];
    try {
      const s = await getDocs(query(
        collection(db, 'writing_attempts'),
        where('uid', '==', user.uid),
        orderBy('timestamp', 'desc')
      ));
      writingAttempts = s.docs.map(d => d.data());
    } catch(e) { console.warn('writing_attempts:', e); }

    document.getElementById('loading').style.display = 'none';
    buildProfile(user, quizAttempts, recordings, writingAttempts);

  } catch(err) {
    console.error(err);
    document.getElementById('loading').innerHTML =
      `<div class="empty-state"><span>‚ö†Ô∏è</span>Failed to load profile. Please try again.</div>`;
  }
});
</script>
</body>
</html>
