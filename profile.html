<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile â€” Chinese60s</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --black: #222;
      --green: #7cb83e;
      --green-dark: #5a8f27;
      --green-light: #d8f0a0;
      --green-pale: #f2fde0;
      --yellow: #ffd84d;
      --yellow-pale: #fffbe6;
      --peach: #ffb89a;
      --peach-pale: #fff3ee;
      --sky: #72c8f0;
      --sky-pale: #eaf8ff;
      --lavender: #c5b0f8;
      --lavender-pale: #f3f0ff;
      --pink: #ffadc5;
      --pink-pale: #fff2f6;
      --white: #fff;
      --bg: #fffef5;
      --shadow-sm: 3px 3px 0 var(--black);
      --shadow-md: 4px 4px 0 var(--black);
      --shadow-lg: 6px 6px 0 var(--black);
      --border: 2.5px solid var(--black);
      --border-thick: 3px solid var(--black);
    }
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior:smooth; }
    body {
      font-family:'Fredoka',sans-serif; font-weight:500;
      background:var(--bg); color:var(--black);
      min-height:100vh; display:flex; flex-direction:column; overflow-x:hidden;
    }
    body::before {
      content:''; position:fixed; inset:0;
      background-image:radial-gradient(circle,rgba(0,0,0,.045) 1px,transparent 1px);
      background-size:22px 22px; pointer-events:none; z-index:0;
    }

    /* HEADER */
    header {
      background:var(--green); border-bottom:var(--border-thick);
      padding:0 50px; height:66px;
      display:flex; justify-content:space-between; align-items:center;
      position:sticky; top:0; z-index:100;
    }
    header h1 { font-weight:700; font-size:1.7rem; color:#fff; letter-spacing:.04em; text-shadow:2px 2px 0 rgba(0,0,0,.25); }
    .homepage-link { text-decoration:none; color:inherit; }
    nav ul { list-style:none; display:flex; gap:8px; align-items:center; }
    nav ul li a {
      text-decoration:none; color:var(--black); font-weight:600; font-size:.95rem;
      background:var(--white); border:var(--border); border-radius:50px;
      padding:6px 16px; display:inline-block;
      box-shadow:var(--shadow-sm); transition:transform .12s,box-shadow .12s;
    }
    nav ul li a:hover { transform:translate(-2px,-2px); box-shadow:5px 5px 0 var(--black); }
    @media(max-width:768px){ header{padding:0 16px;} }

    .container {
      max-width:1000px; margin:0 auto; width:100%;
      padding:36px 24px 80px; position:relative; z-index:1;
      display:flex; flex-direction:column; gap:20px;
    }

    /* LOADING */
    .loading-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; padding:80px 0; }
    .loading-dots { display:flex; gap:8px; }
    .loading-dots span { width:12px; height:12px; border-radius:50%; background:var(--green); animation:bounce .8s ease-in-out infinite; }
    .loading-dots span:nth-child(2){ animation-delay:.15s; background:var(--yellow); }
    .loading-dots span:nth-child(3){ animation-delay:.3s; background:var(--pink); }
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    .loading-screen p { font-size:1rem; color:#888; font-weight:600; }

    /* ANIMATIONS */
    @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

    /* PROFILE HERO */
    .profile-hero {
      background:var(--white); border:var(--border-thick); border-radius:24px;
      box-shadow:var(--shadow-md); padding:24px 28px;
      display:flex; align-items:center; gap:20px; flex-wrap:wrap;
      animation:slideUp .3s ease both;
    }
    .profile-avatar { width:72px; height:72px; border-radius:50%; border:var(--border-thick); object-fit:cover; display:block; }
    .profile-avatar-fallback { width:72px; height:72px; border-radius:50%; border:var(--border-thick); background:var(--green-light); display:flex; align-items:center; justify-content:center; font-size:1.8rem; font-weight:700; }
    .profile-info { flex:1; min-width:0; }
    .profile-info h2 { font-size:1.6rem; font-weight:700; }
    .profile-info p { font-size:.9rem; color:#666; margin-top:3px; }
    .badges { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .badge { display:inline-flex; align-items:center; gap:5px; border:var(--border); border-radius:50px; padding:3px 12px; font-size:.82rem; font-weight:700; box-shadow:var(--shadow-sm); }
    .badge.learner { background:var(--green-pale); }
    .badge.streak  { background:var(--peach-pale); }
    .signout-btn { background:var(--pink-pale); border:var(--border); border-radius:50px; padding:8px 20px; font-family:'Fredoka',sans-serif; font-weight:700; font-size:.9rem; cursor:pointer; box-shadow:var(--shadow-sm); color:#c0392b; transition:transform .12s,box-shadow .12s; flex-shrink:0; }
    .signout-btn:hover { transform:translate(-2px,-2px); box-shadow:5px 5px 0 var(--black); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TODAY SCORE â€” BIG CARD ON TOP
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .today-score-card {
      background:var(--white); border:var(--border-thick); border-radius:24px;
      box-shadow:var(--shadow-lg); padding:28px 32px;
      animation:slideUp .3s .08s ease both;
      position:relative; overflow:hidden;
    }
    .today-score-card::before {
      content:''; position:absolute; inset:0;
      background:linear-gradient(135deg, var(--yellow-pale) 0%, var(--green-pale) 100%);
      z-index:0;
    }
    .today-score-card > * { position:relative; z-index:1; }

    .today-header {
      display:flex; align-items:center; justify-content:space-between;
      flex-wrap:wrap; gap:12px; margin-bottom:22px;
    }
    .today-label {
      font-weight:700; font-size:1rem; color:#666;
      text-transform:uppercase; letter-spacing:.08em;
    }
    .today-date { font-size:.85rem; color:#999; font-weight:600; }

    .today-big-score {
      text-align:center; margin-bottom:24px;
    }
    .today-big-score .num {
      font-size:5rem; font-weight:700; line-height:1;
      display:block;
    }
    .today-big-score .num.positive { color:var(--green-dark); }
    .today-big-score .num.zero     { color:#bbb; }
    .today-big-score .num.negative { color:#e53935; }
    .today-big-score .pts-label {
      font-size:1rem; color:#888; font-weight:600; margin-top:4px;
    }

    /* Penalty notice */
    .penalty-notice {
      display:inline-flex; align-items:center; gap:6px;
      background:var(--pink-pale); border:2px solid #e53935;
      border-radius:50px; padding:5px 14px;
      font-size:.82rem; font-weight:700; color:#c0392b;
      margin-bottom:16px;
    }

    /* Today breakdown row */
    .today-breakdown {
      display:grid; grid-template-columns:repeat(3,1fr); gap:12px;
    }
    @media(max-width:480px){ .today-breakdown{grid-template-columns:1fr;} }

    .today-block {
      border:var(--border); border-radius:16px; padding:14px 12px;
      text-align:center; background:rgba(255,255,255,.7);
      backdrop-filter:blur(4px);
    }
    .today-block .tb-num  { font-size:1.8rem; font-weight:700; line-height:1; }
    .today-block .tb-lbl  { font-size:.78rem; font-weight:700; color:#666; text-transform:uppercase; letter-spacing:.05em; margin-top:4px; }
    .today-block .tb-sub  { font-size:.72rem; color:#aaa; margin-top:2px; }

    /* Missed day warning */
    .missed-warning {
      margin-top:16px; padding:12px 16px;
      background:rgba(255,255,255,.8); border:var(--border); border-radius:14px;
      font-size:.88rem; color:#888; font-weight:600; text-align:center;
    }
    .missed-warning strong { color:#e53935; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ALL-TIME â€” COMPACT CARD BELOW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .alltime-card {
      background:var(--white); border:var(--border-thick); border-radius:20px;
      box-shadow:var(--shadow-sm); padding:18px 22px;
      animation:slideUp .3s .14s ease both;
    }
    .alltime-toggle {
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer; user-select:none;
    }
    .alltime-toggle h3 {
      font-size:.95rem; font-weight:700; color:#888;
      text-transform:uppercase; letter-spacing:.07em;
      display:flex; align-items:center; gap:8px;
    }
    .alltime-toggle .chevron { font-size:.85rem; transition:transform .2s; }
    .alltime-toggle.open .chevron { transform:rotate(180deg); }

    .alltime-body { display:none; margin-top:16px; }
    .alltime-body.open { display:block; }

    .alltime-row {
      display:grid; grid-template-columns:repeat(4,1fr); gap:10px;
      margin-bottom:14px;
    }
    @media(max-width:500px){ .alltime-row{grid-template-columns:repeat(2,1fr);} }

    .at-block {
      border:var(--border); border-radius:14px; padding:12px 10px;
      text-align:center; transition:transform .1s;
    }
    .at-block:hover { transform:translate(-1px,-1px); }
    .at-block.total { background:var(--yellow-pale); }
    .at-block.quiz  { background:var(--green-pale); }
    .at-block.speak { background:var(--sky-pale); }
    .at-block.write { background:var(--lavender-pale); }
    .at-block .an   { font-size:1.6rem; font-weight:700; line-height:1; }
    .at-block .al   { font-size:.72rem; font-weight:700; color:#666; text-transform:uppercase; letter-spacing:.05em; margin-top:4px; }

    .penalty-row {
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; background:var(--pink-pale);
      border:var(--border); border-radius:12px;
      font-size:.85rem; font-weight:700;
    }
    .penalty-row .pr-label { color:#888; }
    .penalty-row .pr-val   { color:#e53935; }

    /* DETAIL TABS */
    .section-card { background:var(--white); border:var(--border-thick); border-radius:20px; box-shadow:var(--shadow-md); padding:22px 26px; animation:slideUp .3s .2s ease both; }
    .section-title { display:inline-block; font-weight:700; font-size:1.1rem; background:var(--yellow); border:var(--border); border-radius:50px; padding:5px 18px; box-shadow:var(--shadow-sm); margin-bottom:16px; }
    .tabs { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
    .tab-btn { padding:6px 16px; border:var(--border); border-radius:50px; font-family:'Fredoka',sans-serif; font-weight:700; font-size:.88rem; cursor:pointer; background:var(--white); box-shadow:var(--shadow-sm); transition:transform .1s; }
    .tab-btn:hover { transform:translate(-1px,-1px); }
    .tab-btn.active { background:var(--green); color:#fff; }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }

    /* QUIZ */
    .attempt-block { background:var(--bg); border:var(--border); border-radius:14px; padding:14px 16px; margin-bottom:10px; }
    .attempt-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; flex-wrap:wrap; gap:6px; }
    .meta { font-size:.8rem; color:#888; }
    .score-badge { padding:3px 10px; border-radius:50px; font-size:.82rem; font-weight:700; border:2px solid var(--black); }
    .score-badge.good { background:var(--green-light); }
    .score-badge.ok   { background:var(--yellow); }
    .score-badge.low  { background:var(--pink); }
    .score-badge.write-col { background:var(--lavender); }
    .wrong-list { display:flex; flex-direction:column; gap:4px; margin-top:6px; }
    .wrong-item { display:flex; align-items:flex-start; gap:7px; padding:6px 10px; border-radius:9px; background:var(--white); border:var(--border); font-size:.82rem; }
    .wrong-x { color:#e53935; font-weight:700; flex-shrink:0; }
    .q-label { font-size:.76rem; color:#aaa; margin-bottom:2px; }
    .correct-ans { color:var(--green-dark); font-weight:700; }

    /* SPEAK */
    .rec-item { padding:10px 14px; border-radius:12px; background:var(--white); border:var(--border); margin-bottom:7px; font-size:.88rem; line-height:1.5; }
    .rec-said { font-weight:700; font-size:1rem; }
    .rec-original { color:#6366f1; font-weight:600; font-size:.82rem; margin-top:2px; }
    .rec-meta-sm { font-size:.73rem; color:#bbb; margin-top:2px; }

    /* WRITE */
    .zero-banner { background:var(--pink-pale); border:var(--border); border-radius:13px; padding:12px 14px; margin-bottom:14px; }
    .zero-banner h4 { font-size:.85rem; font-weight:700; color:#c0392b; margin-bottom:9px; }
    .char-grid { display:flex; flex-wrap:wrap; gap:9px; }
    .char-pill { width:46px; height:46px; border-radius:10px; border:2.5px solid #e53935; background:var(--white); display:flex; align-items:center; justify-content:center; font-size:1.4rem; font-weight:700; color:#e53935; box-shadow:var(--shadow-sm); }
    .char-pill.half { border-color:#f39c12; color:#f39c12; }

    /* EMPTY */
    .empty-state { text-align:center; padding:22px 0; color:#bbb; font-size:.92rem; font-weight:600; }
    .empty-state span { font-size:1.6rem; display:block; margin-bottom:5px; }

    /* FOOTER */
    footer { background:#222; color:rgba(255,255,255,.65); padding:28px 50px; text-align:center; position:relative; z-index:1; margin-top:auto; }
    footer .brand { font-weight:700; color:var(--green-light); font-size:1.3rem; margin-bottom:6px; }
  </style>
</head>
<body>

<header>
  <h1><a href="index.html" class="homepage-link">CHINESE 60s</a></h1>
  <nav><ul><li><a href="index.html">â† Back</a></li></ul></nav>
</header>

<div class="container" id="app">
  <div class="loading-screen" id="loading">
    <div class="loading-dots"><span></span><span></span><span></span></div>
    <p>Loading your profile...</p>
  </div>
</div>

<footer>
  <p class="brand">CHINESE 60s</p>
  <p>Learn Mandarin through images and videos</p>
</footer>

<script type="module">
import { initializeApp }    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut }
                             from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, orderBy }
                             from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyAm-qQrpXKNdqFLITRAGCug7rkskGzyAkg",
  authDomain:        "chinese60s.firebaseapp.com",
  projectId:         "chinese60s",
  storageBucket:     "chinese60s.firebasestorage.app",
  messagingSenderId: "835657861121",
  appId:             "1:835657861121:web:f31727eb7ea3b876a5d800",
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* â•â•â• HELPERS â•â•â• */
function tsToDate(ts) {
  if (!ts) return null;
  if (ts.toDate)  return ts.toDate();
  if (ts.seconds) return new Date(ts.seconds * 1000);
  return new Date(ts);
}
function toDateStr(ts) {
  const d = tsToDate(ts);
  return d ? d.toISOString().split('T')[0] : null;
}
function fmtDate(ts) {
  const d = tsToDate(ts);
  if (!d) return 'â€”';
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit' });
}
function todayStr() {
  return new Date().toISOString().split('T')[0];
}
function isToday(ts) { return toDateStr(ts) === todayStr(); }
function scoreBadge(s, t) {
  const p = t ? s/t : 0;
  return p >= 0.8 ? 'good' : p >= 0.5 ? 'ok' : 'low';
}

/* â•â•â• PENALTY CALC â•â•â•
   Äáº¿m sá»‘ ngÃ y KHÃ”NG cÃ³ hoáº¡t Ä‘á»™ng, tÃ­nh tá»« ngÃ y Ä‘áº§u tiÃªn cÃ³ activity Ä‘áº¿n hÃ´m nay
   Má»—i ngÃ y nghá»‰: -2 Ä‘iá»ƒm
*/
function calcPenalty(quizzes, recs, writes) {
  // Táº­p há»£p táº¥t cáº£ ngÃ y cÃ³ hoáº¡t Ä‘á»™ng
  const activeDays = new Set();
  quizzes.forEach(a => { const s = toDateStr(a.startTime); if (s) activeDays.add(s); });
  recs.forEach(r    => { const s = toDateStr(r.timestamp);  if (s) activeDays.add(s); });
  writes.forEach(w  => { const s = toDateStr(w.timestamp);  if (s) activeDays.add(s); });

  if (!activeDays.size) return { penalty: 0, missedDays: 0 };

  // NgÃ y Ä‘áº§u tiÃªn cÃ³ activity
  const sorted = [...activeDays].sort();
  const firstDay = new Date(sorted[0]);
  const today    = new Date(todayStr());

  // Äáº¿m tá»«ng ngÃ y tá»« firstDay â†’ today (khÃ´ng tÃ­nh today náº¿u chÆ°a cÃ³ activity hÃ´m nay)
  let missedDays = 0;
  const cur = new Date(firstDay);
  while (cur < today) {
    const str = cur.toISOString().split('T')[0];
    if (!activeDays.has(str)) missedDays++;
    cur.setDate(cur.getDate() + 1);
  }

  return { penalty: missedDays * 2, missedDays };
}

/* â•â•â• STREAK â•â•â• */
function calcStreak(quizzes, recs, writes) {
  const days = new Set();
  quizzes.forEach(a => { const s = toDateStr(a.startTime); if (s) days.add(s); });
  recs.forEach(r    => { const s = toDateStr(r.timestamp);  if (s) days.add(s); });
  writes.forEach(w  => { const s = toDateStr(w.timestamp);  if (s) days.add(s); });
  if (!days.size) return 0;
  let streak = 0, check = new Date();
  for (let i = 0; i < 365; i++) {
    const str = check.toISOString().split('T')[0];
    if (days.has(str)) streak++;
    else if (i > 0) break;
    check.setDate(check.getDate() - 1);
  }
  return streak;
}

/* â•â•â• FETCH â•â•â• */
async function fetchCol(col, uid, tsField) {
  try {
    const snap = await getDocs(query(
      collection(db, col),
      where('uid', '==', uid),
      orderBy(tsField, 'desc')
    ));
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  } catch(e) {
    // Fallback: no orderBy (no index needed)
    try {
      const snap = await getDocs(query(collection(db, col), where('uid', '==', uid)));
      const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      docs.sort((a,b) => {
        const ta = tsToDate(a[tsField]), tb = tsToDate(b[tsField]);
        return (tb||0) - (ta||0);
      });
      return docs;
    } catch(e2) {
      console.error(col, e2);
      return [];
    }
  }
}

/* â•â•â• RENDER â•â•â• */
function render(user, quizzes, recs, writes) {

  const today = todayStr();

  /* â”€â”€ TODAY DATA â”€â”€ */
  const todayQuizzes = quizzes.filter(a => isToday(a.startTime));
  const todayRecs    = recs.filter(r    => isToday(r.timestamp));
  const todayWrites  = writes.filter(w  => isToday(w.timestamp));

  const todayQuizScore  = todayQuizzes.reduce((s,a) => s + (Number(a.score)||0), 0);
  const todaySpeakScore = todayRecs.length;
  const todayWriteScore = Math.round(todayWrites.reduce((s,a) => s + (Number(a.score)||0), 0) * 10) / 10;
  const todayRaw        = todayQuizScore + todaySpeakScore + todayWriteScore;

  // HÃ´m nay cÃ³ activity khÃ´ng?
  const activeToday = todayQuizzes.length > 0 || todayRecs.length > 0 || todayWrites.length > 0;

  /* â”€â”€ ALL-TIME â”€â”€ */
  const allQuizScore  = quizzes.reduce((s,a) => s + (Number(a.score)||0), 0);
  const allSpeakScore = recs.length;
  const allWriteScore = Math.round(writes.reduce((s,a) => s + (Number(a.score)||0), 0) * 10) / 10;
  const allRaw        = Math.round((allQuizScore + allSpeakScore + allWriteScore) * 10) / 10;

  /* â”€â”€ PENALTY â”€â”€ */
  const { penalty, missedDays } = calcPenalty(quizzes, recs, writes);
  const allTotal = Math.round((allRaw - penalty) * 10) / 10;

  /* â”€â”€ TODAY TOTAL (khÃ´ng trá»« penalty â€” penalty tÃ­nh trÃªn tá»•ng) â”€â”€ */
  // Náº¿u hÃ´m nay KHÃ”NG há»c: hiá»‡n cáº£nh bÃ¡o sáº½ bá»‹ trá»« 2Ä‘ vÃ o ngÃ y mai
  const todayDisplay = Math.round(todayRaw * 10) / 10;

  const streak = calcStreak(quizzes, recs, writes);

  /* â”€â”€ ZERO WRITE CHARS â”€â”€ */
  const zeroSet = new Set();
  writes.forEach(a =>
    (a.wrongAnswers||[]).forEach(w => {
      if ((w.pointsEarned === 0 || w.wrongAttempts >= 2) && w.character) zeroSet.add(w.character);
    })
  );

  const todayLabel = new Date().toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' });

  const scoreClass = todayDisplay > 0 ? 'positive' : todayDisplay < 0 ? 'negative' : 'zero';

  document.getElementById('app').innerHTML = `

    <!-- PROFILE HERO -->
    <div class="profile-hero">
      <div>
        ${user.photoURL
          ? `<img class="profile-avatar" src="${user.photoURL}" referrerpolicy="no-referrer" alt="">`
          : `<div class="profile-avatar-fallback">${(user.displayName?.[0]||'?').toUpperCase()}</div>`}
      </div>
      <div class="profile-info">
        <h2>${user.displayName || 'Learner'}</h2>
        <p>${user.email}</p>
        <div class="badges">
          <span class="badge learner">ğŸ“ Chinese Learner</span>
          ${streak > 0 ? `<span class="badge streak">ğŸ”¥ ${streak}-day streak</span>` : ''}
        </div>
      </div>
      <button class="signout-btn" id="signout-btn">ğŸšª Sign Out</button>
    </div>

    <!-- TODAY SCORE â€” BIG CARD -->
    <div class="today-score-card">
      <div class="today-header">
        <span class="today-label">ğŸ“… Today's Score</span>
        <span class="today-date">${todayLabel}</span>
      </div>

      <div class="today-big-score">
        <span class="num ${scoreClass}">${todayDisplay >= 0 ? '+' : ''}${todayDisplay}</span>
        <span class="pts-label">points earned today</span>
      </div>

      ${!activeToday ? `
        <div style="text-align:center;margin-bottom:16px">
          <span class="penalty-notice">âš ï¸ No activity today â€” will lose 2 pts tomorrow</span>
        </div>` : ''}

      <div class="today-breakdown">
        <div class="today-block">
          <div class="tb-num">${todayQuizScore}</div>
          <div class="tb-lbl">ğŸ“ Quiz</div>
          <div class="tb-sub">${todayQuizzes.length} session${todayQuizzes.length !== 1 ? 's' : ''}</div>
        </div>
        <div class="today-block">
          <div class="tb-num">${todaySpeakScore}</div>
          <div class="tb-lbl">ğŸ™ Speak</div>
          <div class="tb-sub">${todaySpeakScore} sentence${todaySpeakScore !== 1 ? 's' : ''}</div>
        </div>
        <div class="today-block">
          <div class="tb-num">${todayWriteScore}</div>
          <div class="tb-lbl">âœï¸ Write</div>
          <div class="tb-sub">${todayWrites.length} session${todayWrites.length !== 1 ? 's' : ''}</div>
        </div>
      </div>

      ${missedDays > 0 ? `
        <div class="missed-warning">
          ğŸ“‰ You missed <strong>${missedDays} day${missedDays > 1 ? 's' : ''}</strong> total
          â†’ <strong style="color:#e53935">âˆ’${penalty} pts</strong> deducted from your all-time score
        </div>` : ''}
    </div>

    <!-- ALL-TIME â€” COMPACT COLLAPSIBLE -->
    <div class="alltime-card">
      <div class="alltime-toggle" id="alltime-toggle">
        <h3>ğŸ“Š All-time Score <span style="color:var(--black);font-size:1rem;margin-left:4px">ğŸ† ${allTotal}</span></h3>
        <span class="chevron">â–¼</span>
      </div>
      <div class="alltime-body" id="alltime-body">
        <div class="alltime-row">
          <div class="at-block total">
            <div class="an">${allTotal}</div>
            <div class="al">ğŸ† Net Total</div>
          </div>
          <div class="at-block quiz">
            <div class="an">${allQuizScore}</div>
            <div class="al">ğŸ“ Quiz</div>
          </div>
          <div class="at-block speak">
            <div class="an">${allSpeakScore}</div>
            <div class="al">ğŸ™ Speak</div>
          </div>
          <div class="at-block write">
            <div class="an">${allWriteScore}</div>
            <div class="al">âœï¸ Write</div>
          </div>
        </div>
        ${penalty > 0 ? `
          <div class="penalty-row">
            <span class="pr-label">âš ï¸ Penalty (${missedDays} missed day${missedDays > 1 ? 's' : ''} Ã— 2)</span>
            <span class="pr-val">âˆ’${penalty} pts</span>
          </div>` : `
          <div style="font-size:.85rem;color:var(--green-dark);font-weight:700;text-align:center;padding:8px">
            âœ… No missed days â€” keep it up!
          </div>`}
        <div style="font-size:.78rem;color:#bbb;text-align:center;margin-top:10px">
          ${allQuizScore} (quiz) + ${allSpeakScore} (speak) + ${allWriteScore} (write) âˆ’ ${penalty} (penalty) = ${allTotal}
        </div>
      </div>
    </div>

    <!-- DETAIL TABS -->
    <div class="section-card">
      <div class="section-title">ğŸ“‹ Activity Details</div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="quiz">ğŸ“ Quiz (${quizzes.length})</button>
        <button class="tab-btn"        data-tab="speak">ğŸ™ Speak (${allSpeakScore})</button>
        <button class="tab-btn"        data-tab="write">âœï¸ Write (${writes.length})</button>
      </div>

      <!-- QUIZ TAB -->
      <div class="tab-panel active" id="tab-quiz">
        ${quizzes.length === 0
          ? `<div class="empty-state"><span>ğŸ“</span>No quiz attempts yet</div>`
          : quizzes.map(a => {
              const wrong = a.wrongAnswers || [];
              const tot   = a.totalQuestions || 0;
              const pct   = tot ? Math.round((a.score||0)/tot*100) : 0;
              const isTod = isToday(a.startTime);
              return `
                <div class="attempt-block" style="${isTod ? 'border-color:var(--green);' : ''}">
                  <div class="attempt-header">
                    <div>
                      ${isTod ? `<span style="font-size:.72rem;font-weight:700;color:var(--green-dark);background:var(--green-pale);border-radius:50px;padding:2px 8px;margin-right:6px">TODAY</span>` : ''}
                      <strong>Lesson #${a.postId||'?'}</strong>
                      <span class="meta" style="margin-left:6px">${fmtDate(a.startTime)}</span>
                    </div>
                    <span class="score-badge ${scoreBadge(a.score||0, tot)}">${a.score||0}/${tot} (${pct}%)</span>
                  </div>
                  ${wrong.length > 0
                    ? `<div class="wrong-list">${wrong.map(w => `
                        <div class="wrong-item">
                          <span class="wrong-x">âœ—</span>
                          <div>
                            ${w.question ? `<div class="q-label">${w.question}</div>` : ''}
                            <div>You: <em style="color:#c0392b">${w.given||'?'}</em> â†’ <span class="correct-ans">âœ“ ${w.answer||'?'}</span></div>
                          </div>
                        </div>`).join('')}</div>`
                    : `<div style="font-size:.82rem;color:var(--green-dark);font-weight:700;margin-top:4px">âœ… Perfect!</div>`}
                </div>`;
            }).join('')}
      </div>

      <!-- SPEAK TAB -->
      <div class="tab-panel" id="tab-speak">
        ${recs.length === 0
          ? `<div class="empty-state"><span>ğŸ™</span>No recordings yet</div>`
          : `<p style="font-size:.82rem;color:#888;margin-bottom:12px;font-weight:600">
               1 pt per sentence. Total: <strong style="color:var(--black)">${allSpeakScore} pts</strong>
             </p>
             ${recs.map(r => {
               const isTod = isToday(r.timestamp);
               return `
                 <div class="rec-item" style="${isTod ? 'border-color:var(--sky);' : ''}">
                   ${isTod ? `<span style="font-size:.7rem;font-weight:700;color:#0077aa;background:var(--sky-pale);border-radius:50px;padding:1px 8px;margin-bottom:3px;display:inline-block">TODAY</span><br>` : ''}
                   <div class="rec-said">ğŸ—£ ${r.transcript || '(no transcript)'}</div>
                   <div class="rec-original">Original: ${r.correctSentence || 'â€”'}</div>
                   <div class="rec-meta-sm">Lesson #${r.postId||'?'} Â· ${fmtDate(r.timestamp)}</div>
                 </div>`;
             }).join('')}`}
      </div>

      <!-- WRITE TAB -->
      <div class="tab-panel" id="tab-write">
        ${writes.length === 0
          ? `<div class="empty-state"><span>âœï¸</span>No writing practice yet</div>`
          : `
            ${zeroSet.size > 0 ? `
              <div class="zero-banner">
                <h4>âŒ Characters to review (0 pt â€” 2+ mistakes):</h4>
                <div class="char-grid">
                  ${[...zeroSet].map(c => `<div class="char-pill">${c}</div>`).join('')}
                </div>
              </div>` : ''}
            ${writes.map(a => {
              const isTod  = isToday(a.timestamp);
              const zeroCh = (a.wrongAnswers||[]).filter(w => w.pointsEarned===0||w.wrongAttempts>=2).map(w=>w.character).filter(Boolean);
              const halfCh = (a.wrongAnswers||[]).filter(w => w.pointsEarned===0.5||w.wrongAttempts===1).map(w=>w.character).filter(Boolean);
              return `
                <div class="attempt-block" style="${isTod ? 'border-color:var(--lavender);' : ''}">
                  <div class="attempt-header">
                    <div>
                      ${isTod ? `<span style="font-size:.72rem;font-weight:700;color:#6366f1;background:var(--lavender-pale);border-radius:50px;padding:2px 8px;margin-right:6px">TODAY</span>` : ''}
                      <strong>Lesson #${a.postId||'?'}</strong>
                      <span class="meta" style="margin-left:6px">${fmtDate(a.timestamp)}</span>
                    </div>
                    <span class="score-badge write-col">${a.score} / ${a.totalCards} pts</span>
                  </div>
                  ${zeroCh.length > 0 ? `
                    <div style="margin-bottom:6px">
                      <span style="font-size:.75rem;font-weight:700;color:#e53935;text-transform:uppercase">0 pt:</span>
                      <div class="char-grid" style="margin-top:5px">${zeroCh.map(c=>`<div class="char-pill">${c}</div>`).join('')}</div>
                    </div>` : ''}
                  ${halfCh.length > 0 ? `
                    <div>
                      <span style="font-size:.75rem;font-weight:700;color:#f39c12;text-transform:uppercase">0.5 pt:</span>
                      <div class="char-grid" style="margin-top:5px">${halfCh.map(c=>`<div class="char-pill half">${c}</div>`).join('')}</div>
                    </div>` : ''}
                  ${zeroCh.length===0&&halfCh.length===0
                    ? `<div style="font-size:.82rem;color:var(--green-dark);font-weight:700">âœ… All correct!</div>`
                    : ''}
                </div>`;
            }).join('')}`}
      </div>

    </div>
  `;

  /* Sign out */
  document.getElementById('signout-btn').addEventListener('click', async () => {
    await signOut(auth);
    window.location.href = 'index.html';
  });

  /* Tabs */
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
  });

  /* Collapsible all-time */
  const toggle = document.getElementById('alltime-toggle');
  const body   = document.getElementById('alltime-body');
  toggle.addEventListener('click', () => {
    const open = body.classList.toggle('open');
    toggle.classList.toggle('open', open);
  });
}

/* â•â•â• MAIN â•â•â• */
onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href = 'index.html'; return; }

  const [quizzes, recs, writes] = await Promise.all([
    fetchCol('quiz_attempts',   user.uid, 'startTime'),
    fetchCol('recordings',      user.uid, 'timestamp'),
    fetchCol('writing_attempts',user.uid, 'timestamp'),
  ]);

  document.getElementById('loading').style.display = 'none';
  render(user, quizzes, recs, writes);
});
</script>
</body>
</html>
